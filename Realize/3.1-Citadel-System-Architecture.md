---
title: "Citadel V2 System Architecture"
date: "2025-09-28"
type: "architecture"
phase: "realize"
status: "active"
version: "3.1"
---

# Citadel V2 System Architecture

**Document Purpose:** Define the comprehensive system architecture for Citadel V2, including component design, service boundaries, integration patterns, and deployment topology.

**Architecture Date:** 2025-09-28  
**Architecture Team:** HX Data Ingestion Project  
**Status:** Active - Implementation Ready  
**Related Documents:** Constitution v1.0, Implementation Plan v2.0, Stakeholder Requirements

---

## Executive Summary

Citadel V2 is an enterprise-grade, agent-first data ingestion and RAG platform designed to transform foundational LLMs into domain experts through intelligent data acquisition and retrieval-augmented generation. The architecture implements distributed services with event-driven communication, comprehensive security, and production-ready operational excellence.

### Key Architectural Principles

1. **Agent-First Design** - All processing components implemented as intelligent agents
2. **Event-Driven Architecture** - Real-time communication through AG-UI event bus
3. **Microservices Pattern** - Distributed services with clear boundaries and responsibilities
4. **Security-by-Design** - Zero-trust network with comprehensive security controls
5. **Production Readiness** - Enterprise-grade capabilities with ≥99.9% availability target

---

## System Overview

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Citadel V2 Architecture                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────┐     │
│  │                    Presentation Layer                          │     │
│  ├───────────────────────────────────────────────────────────────┤     │
│  │  Open Web-UI Frontend  │  LiveKit Real-Time  │  Voice UI      │     │
│  │  - React Components    │  - WebRTC Collab    │  - Voice Search│     │
│  │  - Real-time Updates   │  - Co-monitoring    │  - Voice Query │     │
│  │  - Responsive Design   │  - Voice Integration│  - Transcripts │     │
│  └───────────────────────────────────────────────────────────────┘     │
│                                  ▲                                        │
│                                  │ HTTPS/WSS                             │
│                                  ▼                                        │
│  ┌───────────────────────────────────────────────────────────────┐     │
│  │                   API Gateway & Security Layer                 │     │
│  ├───────────────────────────────────────────────────────────────┤     │
│  │  Clerk Authentication  │  API Gateway  │  Rate Limiting       │     │
│  │  - Enterprise SSO      │  - Routing    │  - Throttling        │     │
│  │  - RBAC               │  - Load Bal   │  - Circuit Breaker   │     │
│  │  - MFA                │  - Security   │  - Health Checks     │     │
│  └───────────────────────────────────────────────────────────────┘     │
│                                  ▲                                        │
│                                  │ Internal Network                      │
│                                  ▼                                        │
│  ┌───────────────────────────────────────────────────────────────┐     │
│  │                   Application Services Layer                   │     │
│  ├───────────────────────────────────────────────────────────────┤     │
│  │  Acquisition Service  │  Indexing Service  │  Retrieval Svc   │     │
│  │  - Agent Management   │  - Vector Embed    │  - Query Process │     │
│  │  - Job Scheduling     │  - Chunk Storage   │  - Context Build │     │
│  │  - Progress Tracking  │  - Metadata Index  │  - Response Gen  │     │
│  └───────────────────────────────────────────────────────────────┘     │
│                                  ▲                                        │
│                                  │ Event Bus                             │
│                                  ▼                                        │
│  ┌───────────────────────────────────────────────────────────────┐     │
│  │                   Agent Processing Layer                       │     │
│  ├───────────────────────────────────────────────────────────────┤     │
│  │  Pydantic-AI Agents                                           │     │
│  │  ┌────────────────┬──────────────────┬───────────────────┐   │     │
│  │  │ Acquisition    │ Processing       │ Retrieval         │   │     │
│  │  │ - Single Page  │ - Content Chunk  │ - Query Agent     │   │     │
│  │  │ - Sequential   │ - Validation     │ - Context Agent   │   │     │
│  │  │ - Parallel     │ - Quality Check  │ - Response Agent  │   │     │
│  │  │ - Recursive    │ - Embedding Gen  │ - Provenance      │   │     │
│  │  └────────────────┴──────────────────┴───────────────────┘   │     │
│  └───────────────────────────────────────────────────────────────┘     │
│                                  ▲                                        │
│                                  │ Data Layer                            │
│                                  ▼                                        │
│  ┌───────────────────────────────────────────────────────────────┐     │
│  │                   Data & Infrastructure Layer                  │     │
│  ├───────────────────────────────────────────────────────────────┤     │
│  │  Qdrant Vector DB  │  PostgreSQL 17  │  Redis Cache         │     │
│  │  - Vector Storage  │  - Metadata     │  - Session Store     │     │
│  │  - Similarity Srch │  - User Data    │  - Query Cache       │     │
│  │  - Distributed     │  - Audit Logs   │  - Rate Limiting     │     │
│  └───────────────────────────────────────────────────────────────┘     │
│                                                                           │
│  ┌───────────────────────────────────────────────────────────────┐     │
│  │              Cross-Cutting Concerns & Support Systems          │     │
│  ├───────────────────────────────────────────────────────────────┤     │
│  │  AG-UI Event Bus  │  LiteLLM Router  │  Monitoring          │     │
│  │  - Real-time Evts │  - Multi-LLM     │  - Metrics           │     │
│  │  - Provenance     │  - Unified API   │  - Logging           │     │
│  │  - Collaboration  │  - Load Balance  │  - Tracing           │     │
│  └───────────────────────────────────────────────────────────────┘     │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Component Architecture

### 1. Presentation Layer

#### Open Web-UI Frontend
**Purpose:** Primary user interface for all Citadel V2 interactions

**Components:**
- **Dashboard Module** - Overview of collections, recent queries, system status
- **Acquisition Module** - Data acquisition job creation and monitoring
- **Collection Module** - Collection management, organization, permissions
- **Query Module** - Natural language query interface with response display
- **Admin Module** - System administration, user management, configuration

**Key Features:**
- Responsive design supporting desktop and mobile
- Real-time updates through WebSocket connections
- Progressive web app capabilities for offline support
- Accessibility compliance (WCAG 2.1 AA)

#### LiveKit Real-Time Communication
**Purpose:** Real-time collaboration and voice integration

**Components:**
- **WebRTC Communication** - Peer-to-peer and multicast support
- **Voice Integration** - Speech-to-text for voice queries
- **Collaboration Features** - Co-monitoring, shared cursors, annotations
- **Screen Sharing** - Collaborative troubleshooting and training

**Key Features:**
- Sub-500ms latency for real-time updates
- Encrypted communication channels
- Automatic reconnection and recovery
- Bandwidth optimization

### 2. Security Layer

#### Clerk Authentication Service
**Purpose:** Enterprise-grade authentication and authorization

**Components:**
- **Identity Management** - User accounts, profiles, credentials
- **Authentication Providers** - SSO (SAML, OIDC), OAuth, email/password
- **Multi-Factor Authentication** - TOTP, SMS, biometric, hardware keys
- **Role-Based Access Control** - Admin, Analyst, Developer roles
- **Collection-Level Permissions** - Fine-grained access control

**Security Features:**
- Zero-trust architecture
- Encrypted credential storage
- Session management with configurable timeouts
- Audit logging for all authentication events

#### API Gateway
**Purpose:** Central entry point for all API requests

**Components:**
- **Request Routing** - Intelligent routing to appropriate services
- **Load Balancing** - Distribution across service instances
- **Rate Limiting** - Per-user and per-endpoint throttling
- **Circuit Breaker** - Failure isolation and graceful degradation
- **Health Checks** - Service availability monitoring

**Key Features:**
- Request/response transformation
- API versioning support
- Correlation ID injection for distributed tracing
- Comprehensive request logging

### 3. Application Services Layer

#### Acquisition Service
**Purpose:** Orchestrate data acquisition operations

**Components:**
- **Agent Manager** - Agent selection, lifecycle, resource allocation
- **Job Scheduler** - Queue management, prioritization, execution
- **Progress Tracker** - Real-time status updates, completion detection
- **Source Connector** - Website crawling, file upload, API integration

**Responsibilities:**
- Accept acquisition requests from UI
- Select appropriate agent based on source type
- Monitor and report progress in real-time
- Handle failures with retry logic
- Emit progress events to AG-UI event bus

**Performance Targets:**
- Support ≥10 concurrent acquisitions
- Process initiation within 100ms
- Progress updates every 500ms

#### Indexing Service
**Purpose:** Transform raw content into searchable vectors

**Components:**
- **Content Chunker** - Smart segmentation based on structure
- **Embedding Generator** - Vector representation creation
- **Metadata Extractor** - Source information, timestamps, relationships
- **Vector Storage Manager** - Qdrant database interaction

**Responsibilities:**
- Receive content from acquisition agents
- Chunk content optimally for retrieval
- Generate embeddings using selected models
- Store vectors with complete metadata
- Maintain provenance relationships

**Performance Targets:**
- Process 1000 chunks per second
- Embedding generation <100ms per chunk
- Vector storage latency <50ms

#### Retrieval Service
**Purpose:** Process queries and generate responses

**Components:**
- **Query Processor** - Natural language understanding, intent extraction
- **Vector Search Engine** - Semantic similarity search
- **Context Builder** - Relevant content assembly
- **Response Generator** - LLM-powered answer generation via LiteLLM
- **Provenance Tracker** - Source attribution, confidence scoring

**Responsibilities:**
- Accept natural language queries
- Perform hybrid search (vector + keyword)
- Build contextual information for LLM
- Generate comprehensive responses
- Provide source attribution and confidence scores

**Performance Targets:**
- P95 query latency ≤2.0 seconds
- Support ≥200 RPS
- Context assembly <500ms

### 4. Agent Processing Layer

#### Pydantic-AI Agent Framework
**Purpose:** Intelligent, autonomous processing agents

**Acquisition Agents:**
- **Single Page Agent** - Basic webpage crawling with markdown conversion
- **Sequential Sitemap Agent** - Resource-efficient sequential processing
- **Parallel Sitemap Agent** - High-throughput parallel processing
- **File Processing Agent** - Local file and upload handling
- **Recursive Exploration Agent** - Autonomous site discovery with depth limits

**Processing Agents:**
- **Content Chunking Agent** - Semantic content segmentation
- **Validation Agent** - Quality assurance and validation
- **Embedding Agent** - Vector representation generation

**Retrieval Agents:**
- **Query Agent** - Natural language query processing
- **Context Agent** - Relevant content assembly
- **Response Agent** - LLM-powered answer generation
- **Provenance Agent** - Source tracking and attribution

**Agent Capabilities:**
- Natural language interfaces
- Tool-based architecture with reusable components
- Error handling with graceful degradation
- Self-monitoring and health reporting
- Event emission for observability

### 5. Data Layer

#### Qdrant Vector Database
**Purpose:** High-performance vector storage and similarity search

**Configuration:**
- Distributed deployment across multiple nodes
- Sharding by collection for horizontal scaling
- Replication factor of 3 for high availability
- HNSW indexing for sub-second search

**Features:**
- Vector similarity search with metadata filtering
- Collection-based multi-tenancy
- Snapshot and backup capabilities
- Metrics and monitoring integration

**Performance:**
- Sub-100ms search latency (P95)
- Support for millions of vectors per collection
- Horizontal scaling to petabyte scale

#### PostgreSQL 17
**Purpose:** Relational data storage for metadata and application data

**Schema Design:**
- **Users & Authentication** - User accounts, roles, permissions
- **Collections** - Collection metadata, ownership, configuration
- **Jobs** - Acquisition job history, status, metrics
- **Audit Logs** - Comprehensive activity tracking

**Features:**
- JSONB support for flexible metadata
- Full-text search capabilities
- Connection pooling (100 connections)
- Automated backups and point-in-time recovery

**Performance:**
- Read-heavy optimization with replica sets
- Query caching through Redis
- Index optimization for common queries

#### Redis Cache
**Purpose:** High-performance caching and session storage

**Use Cases:**
- User session storage
- Query result caching
- Rate limiting counters
- Real-time analytics aggregation

**Configuration:**
- Redis Cluster for horizontal scaling
- Persistence with AOF and RDB
- Eviction policies for memory management
- Pub/Sub for event distribution

### 6. Cross-Cutting Systems

#### AG-UI Event Bus
**Purpose:** Real-time event streaming and collaboration

**Components:**
- **Event Producer** - Service event emission
- **Event Router** - Filtering, routing, delivery
- **Event Consumer** - Frontend and service subscriptions
- **Event Store** - Persistence for replay and audit

**Event Types:**
- **Progress Events** - Acquisition status updates
- **Provenance Events** - Source tracking information
- **Collaboration Events** - Multi-user coordination
- **System Events** - Health, alerts, notifications

**Features:**
- ≤500ms end-to-end latency
- Guaranteed delivery with acknowledgments
- Event replay for recovery
- Multi-protocol support (WebSocket, SSE, gRPC)

#### LiteLLM Router
**Purpose:** Unified LLM interface with multi-provider support

**Capabilities:**
- **Provider Support** - OpenAI, Anthropic, Cohere, Groq, Mistral, local models
- **Load Balancing** - Request distribution across providers
- **Fallback Logic** - Automatic provider switching on failures
- **Cost Tracking** - Token usage and cost monitoring
- **Rate Limiting** - Provider-specific throttling

**Configuration:**
- Primary model configuration with fallback options
- Model-specific parameter optimization
- Streaming response support
- Prompt template management

#### Monitoring & Observability
**Purpose:** Comprehensive system visibility and operational insights

**Components:**
- **Structured Logging** - JSON logs with correlation IDs
- **Metrics Collection** - Prometheus-compatible metrics
- **Distributed Tracing** - OpenTelemetry integration
- **Dashboards** - Real-time system visualization
- **Alerting** - Threshold-based notifications

**Observability Pillars:**
- **Logs** - All service activities, errors, audit events
- **Metrics** - Performance, usage, business KPIs
- **Traces** - Request flows across services
- **Events** - System state changes, alerts

---

## Integration Patterns

### 1. Service-to-Service Communication

**Synchronous Communication:**
- REST APIs for request/response operations
- gRPC for high-performance internal calls
- Circuit breakers for failure isolation
- Timeout and retry policies

**Asynchronous Communication:**
- Event-driven through AG-UI event bus
- Message queues for job processing
- Pub/Sub for real-time updates
- Event sourcing for audit trails

### 2. Data Flow Patterns

**Acquisition Flow:**
```
User Request → API Gateway → Acquisition Service → Agent Selection
    ↓
Agent Execution → Content Extraction → Event Emission
    ↓
Indexing Service → Content Chunking → Embedding Generation
    ↓
Vector Storage → Metadata Storage → Completion Event
```

**Retrieval Flow:**
```
User Query → API Gateway → Retrieval Service → Query Processing
    ↓
Vector Search → Context Assembly → LLM Request (via LiteLLM)
    ↓
Response Generation → Provenance Tracking → User Response
```

### 3. Security Patterns

**Zero-Trust Architecture:**
- All services authenticate with mutual TLS
- Service mesh for encrypted communication
- Least privilege access principles
- Continuous verification and authorization

**Data Protection:**
- Encryption at rest for all data stores
- Encryption in transit with TLS 1.3
- Vault integration for secrets management
- PII detection and redaction policies

---

## Deployment Architecture

### Infrastructure Topology

**15-Server Canonical Deployment (192.168.10.0/24):**

```
┌─────────────────────────────────────────────────────────────┐
│                 HX Infrastructure - 15 Servers               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  Control Plane (3 servers)                                   │
│  ├─ hx-dev-control-01.dev-test.hana-x.ai                    │
│  ├─ hx-dev-control-02.dev-test.hana-x.ai                    │
│  └─ hx-dev-control-03.dev-test.hana-x.ai                    │
│                                                               │
│  Application Services (4 servers)                            │
│  ├─ hx-dev-app-01.dev-test.hana-x.ai  (Acquisition)         │
│  ├─ hx-dev-app-02.dev-test.hana-x.ai  (Indexing)           │
│  ├─ hx-dev-app-03.dev-test.hana-x.ai  (Retrieval)          │
│  └─ hx-dev-app-04.dev-test.hana-x.ai  (API Gateway)        │
│                                                               │
│  Data Services (4 servers)                                   │
│  ├─ hx-dev-data-01.dev-test.hana-x.ai  (Qdrant Master)     │
│  ├─ hx-dev-data-02.dev-test.hana-x.ai  (Qdrant Replica)    │
│  ├─ hx-dev-data-03.dev-test.hana-x.ai  (PostgreSQL)        │
│  └─ hx-dev-data-04.dev-test.hana-x.ai  (Redis)             │
│                                                               │
│  AI Services (2 servers)                                     │
│  ├─ hx-llm01-server  (gpt-oss:20b)                          │
│  └─ hx-llm02-server  (phi3:3.8b)                            │
│                                                               │
│  Monitoring & Support (2 servers)                            │
│  ├─ hx-dev-monitor-01.dev-test.hana-x.ai                    │
│  └─ hx-dev-monitor-02.dev-test.hana-x.ai                    │
│                                                               │
│  Network Infrastructure                                      │
│  ├─ Gateway: 192.168.10.1                                   │
│  ├─ DNS: 192.168.10.2, 192.168.10.3                        │
│  └─ Domain: dev-test.hana-x.ai                              │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### Scaling Considerations

**Horizontal Scaling:**
- Application services scale independently
- Qdrant sharding across additional nodes
- PostgreSQL read replicas for query load
- Redis cluster expansion for cache capacity

**Vertical Scaling:**
- LLM servers: GPU resources for inference
- Qdrant nodes: Memory for vector indices
- PostgreSQL: Storage and connection pools

---

## Non-Functional Requirements

### Performance

**Latency Targets:**
- API Gateway: <50ms P95
- Retrieval Service: ≤2.0s P95 (excluding streaming)
- Event Bus: ≤500ms end-to-end
- Vector Search: <100ms P95

**Throughput Targets:**
- Concurrent Acquisitions: ≥10
- Query Processing: ≥200 RPS
- Event Delivery: ≥1000 events/second
- Vector Indexing: ≥1000 chunks/second

### Availability

**Service Level Objectives:**
- Core APIs: ≥99.9% availability
- Event Bus: ≥99.95% availability
- Data Services: ≥99.95% availability

**Recovery Objectives:**
- RPO (Recovery Point Objective): 5 minutes
- RTO (Recovery Time Objective): 15 minutes
- Automated failover: <30 seconds

### Security

**Authentication:**
- Multi-factor authentication required
- Session timeout: 8 hours (configurable)
- Token expiration: 1 hour with refresh

**Authorization:**
- Collection-level permissions enforced
- API endpoint protection
- Audit logging for all actions

**Data Protection:**
- Encryption at rest: AES-256
- Encryption in transit: TLS 1.3
- PII redaction policies enforced

---

## Operational Considerations

### Monitoring & Alerting

**Key Metrics:**
- Service health and availability
- Request latency and throughput
- Error rates and types
- Resource utilization (CPU, memory, disk)
- Business metrics (acquisitions, queries, users)

**Alert Thresholds:**
- P95 latency >2x baseline
- Error rate >1%
- Service availability <99.9%
- Resource utilization >80%

### Backup & Recovery

**Backup Strategy:**
- PostgreSQL: Daily full backups, continuous WAL archiving
- Qdrant: Snapshot-based backups every 6 hours
- Redis: RDB snapshots every hour, AOF persistence
- Configuration: Version-controlled infrastructure as code

**Disaster Recovery:**
- Multi-region backup storage
- Automated recovery procedures
- Regular disaster recovery drills
- Documented runbooks

### Maintenance & Updates

**Deployment Strategy:**
- Blue-green deployments for zero downtime
- Canary releases for risk mitigation
- Automated rollback on failure detection
- Database migration automation

**Update Schedule:**
- Security patches: Within 24 hours
- Feature updates: Bi-weekly releases
- Infrastructure updates: Monthly maintenance windows

---

## Future Architecture Evolution

### Planned Enhancements

**Multi-Tenant Support:**
- Tenant isolation at data and compute layers
- Per-tenant resource quotas and limits
- Tenant-specific customization capabilities

**Advanced Analytics:**
- Usage pattern analysis and recommendations
- Predictive capacity planning
- Automated performance optimization

**Extended Data Sources:**
- Structured data (SQL, Excel, CSV)
- Document formats (PDF, Word, PowerPoint)
- Media content (images, audio, video)
- Real-time APIs and streaming sources

**AI Capabilities:**
- Model fine-tuning on tenant data
- Custom embedding models
- Specialized domain agents

---

## Conclusion

The Citadel V2 architecture provides a robust, scalable, and secure foundation for enterprise-grade data ingestion and RAG capabilities. The agent-first, event-driven design ensures flexibility and extensibility while maintaining production readiness with comprehensive operational controls.

**Key Architectural Strengths:**
- **Distributed Services** - Clear boundaries, independent scaling
- **Event-Driven Communication** - Real-time collaboration and monitoring
- **Security-by-Design** - Zero-trust with comprehensive controls
- **Production Ready** - Enterprise-grade availability and performance
- **Future-Proof** - Extensible architecture supporting evolution

---

**Document Control**
- **Version:** 3.1
- **Status:** Active - Implementation Ready
- **Next Review:** Upon completion of Phase 1 implementation
- **Related Documents:** Constitution v1.0, Implementation Plan v2.0, Technology Stack v3.2

