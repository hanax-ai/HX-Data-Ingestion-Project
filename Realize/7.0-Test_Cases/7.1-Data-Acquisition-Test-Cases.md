---
title: "Data Acquisition Test Cases"
date: "2025-09-28"
type: "test-cases"
phase: "realize"
feature: "data-acquisition"
version: "7.1"
---

# Data Acquisition Test Cases

**Feature:** Data Acquisition  
**Specification:** 4.5-Citadel-Data-Acquisition.md  
**Total Test Cases:** 80  
**Constitutional Requirement:** Agent-First Architecture

---

## Test Suite Overview

This test suite validates all data acquisition functionality including specialized agents, job management, progress tracking, and content processing.

**Test Categories:**
- Unit Tests: 40 test cases
- Integration Tests: 25 test cases
- E2E Tests: 15 test cases

---

## Unit Tests - Agent Selection

### TC-ACQ-001: Single Page Agent Selection

**Priority:** P0 - Critical  
**Type:** Unit Test  
**Feature:** Agent Selection  
**Specification:** 4.5-Citadel-Data-Acquisition.md  
**Constitutional Requirement:** Agent-First Architecture

#### Description
Verify that the system correctly selects the Single Page Agent when provided with a single URL.

#### Preconditions
- AgentManager initialized
- All agent types registered
- System configuration loaded

#### Test Data
```json
{
  "type": "single_page",
  "url": "https://example.com/page",
  "collection_name": "test-collection"
}
```

#### Test Steps
1. Create acquisition request with single_page type
2. Call AgentManager.select_agent(request)
3. Verify returned agent instance

#### Expected Results
- AgentManager returns SinglePageAgent instance
- Agent is properly configured with request parameters
- Agent has correct tool set loaded

#### Acceptance Criteria
- [ ] SinglePageAgent instance returned
- [ ] Agent configuration matches request
- [ ] No errors or warnings logged

#### Postconditions
- Agent instance ready for execution
- No resources leaked

#### Notes
Tests the core agent selection logic foundation.

---

### TC-ACQ-002: Sitemap Agent Selection

**Priority:** P0 - Critical  
**Type:** Unit Test  
**Feature:** Agent Selection  

#### Description
Verify that the system correctly selects the appropriate Sitemap Agent (Sequential or Parallel) based on URL type and parameters.

#### Preconditions
- AgentManager initialized
- Both sitemap agents registered

#### Test Data
```json
{
  "type": "sitemap",
  "url": "https://example.com/sitemap.xml",
  "collection_name": "test-collection",
  "parallel": true,
  "batch_size": 10
}
```

#### Test Steps
1. Create acquisition request with sitemap type
2. Set parallel flag to true
3. Call AgentManager.select_agent(request)
4. Verify ParallelSitemapAgent returned

#### Expected Results
- ParallelSitemapAgent instance returned
- Agent configured with batch_size=10
- Memory-adaptive dispatcher configured

#### Acceptance Criteria
- [ ] Correct agent type selected
- [ ] Parallel processing configured
- [ ] Batch size set correctly

---

### TC-ACQ-003: Recursive Agent Selection

**Priority:** P0 - Critical  
**Type:** Unit Test  
**Feature:** Agent Selection  

#### Description
Verify RecursiveExplorationAgent selected for recursive crawling requests.

#### Preconditions
- AgentManager initialized
- RecursiveExplorationAgent registered

#### Test Data
```json
{
  "type": "recursive",
  "url": "https://example.com/start",
  "collection_name": "test-collection",
  "depth_limit": 3
}
```

#### Test Steps
1. Create acquisition request with recursive type
2. Set depth_limit parameter
3. Call AgentManager.select_agent(request)
4. Verify RecursiveExplorationAgent returned with depth limit

#### Expected Results
- RecursiveExplorationAgent instance returned
- Depth limit set to 3
- Link discovery tool configured

#### Acceptance Criteria
- [ ] RecursiveExplorationAgent selected
- [ ] Depth limit configured correctly
- [ ] Loop prevention enabled

---

## Unit Tests - Content Processing

### TC-ACQ-010: Markdown Conversion

**Priority:** P1 - High  
**Type:** Unit Test  
**Feature:** Content Processing  

#### Description
Verify HTML to Markdown conversion produces clean, well-formatted Markdown.

#### Preconditions
- MarkdownConverter initialized
- Sample HTML available

#### Test Data
```html
<h1>Title</h1>
<p>This is a <strong>paragraph</strong> with <a href="link">link</a>.</p>
<ul>
  <li>Item 1</li>
  <li>Item 2</li>
</ul>
```

#### Test Steps
1. Load HTML test data
2. Call MarkdownConverter.convert(html)
3. Verify Markdown output

#### Expected Results
```markdown
# Title

This is a **paragraph** with [link](link).

- Item 1
- Item 2
```

#### Acceptance Criteria
- [ ] Headers converted correctly
- [ ] Lists formatted properly
- [ ] Links preserved
- [ ] No HTML artifacts

---

### TC-ACQ-011: Sitemap Parsing

**Priority:** P1 - High  
**Type:** Unit Test  
**Feature:** Content Processing  

#### Description
Verify sitemap XML parsing correctly extracts all URLs.

#### Preconditions
- SitemapParser initialized

#### Test Data
```xml
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url>
    <loc>https://example.com/page1</loc>
    <lastmod>2025-09-28</lastmod>
  </url>
  <url>
    <loc>https://example.com/page2</loc>
    <lastmod>2025-09-27</lastmod>
  </url>
</urlset>
```

#### Test Steps
1. Load sitemap XML
2. Call SitemapParser.parse(xml)
3. Verify extracted URLs

#### Expected Results
- 2 URLs extracted
- URLs: ['https://example.com/page1', 'https://example.com/page2']
- Last modified dates preserved

#### Acceptance Criteria
- [ ] All URLs extracted
- [ ] Metadata preserved
- [ ] No parsing errors

---

### TC-ACQ-012: Link Discovery

**Priority:** P1 - High  
**Type:** Unit Test  
**Feature:** Content Processing  

#### Description
Verify link discovery tool extracts all internal links from HTML content.

#### Preconditions
- LinkDiscovery tool initialized
- Base URL set

#### Test Data
```html
<a href="/page1">Internal Link 1</a>
<a href="/page2">Internal Link 2</a>
<a href="https://external.com">External Link</a>
<a href="#anchor">Anchor Link</a>
```

#### Test Steps
1. Set base URL to "https://example.com"
2. Load HTML content
3. Call LinkDiscovery.extract_links(html, base_url)
4. Verify only internal links returned

#### Expected Results
- 2 internal links extracted
- URLs: ['https://example.com/page1', 'https://example.com/page2']
- External and anchor links filtered out

#### Acceptance Criteria
- [ ] Only internal links returned
- [ ] Relative URLs converted to absolute
- [ ] Duplicates removed

---

## Integration Tests - Acquisition Workflow

### TC-ACQ-020: Complete Single Page Acquisition

**Priority:** P0 - Critical  
**Type:** Integration Test  
**Feature:** Acquisition Workflow  

#### Description
Verify complete workflow for acquiring a single page from submission to vector storage.

#### Preconditions
- Acquisition service running
- Vector database accessible
- Test collection created

#### Test Data
```json
{
  "type": "single_page",
  "url": "https://docs.python.org/3/tutorial/index.html",
  "collection_name": "python-docs-test",
  "description": "Python tutorial documentation"
}
```

#### Test Steps
1. Submit acquisition request via API
2. Monitor job status
3. Wait for completion
4. Verify content in vector database
5. Check progress events emitted

#### Expected Results
- Job status transitions: pending → running → completed
- Progress events emitted with stages
- Content stored in vector database
- Provenance metadata recorded

#### Acceptance Criteria
- [ ] Job completes successfully
- [ ] Content accessible in collection
- [ ] Progress events received
- [ ] Completion time < 30 seconds

#### Postconditions
- Test collection contains document chunks
- Job record persisted in database

---

### TC-ACQ-021: Sequential Sitemap Processing

**Priority:** P0 - Critical  
**Type:** Integration Test  
**Feature:** Acquisition Workflow  

#### Description
Verify sequential sitemap processing handles multiple pages correctly with resource management.

#### Preconditions
- Acquisition service running
- Test sitemap accessible
- Sufficient system resources

#### Test Data
```json
{
  "type": "sitemap",
  "url": "https://example.com/test-sitemap.xml",
  "collection_name": "sitemap-test",
  "parallel": false,
  "rate_limit": 10
}
```

#### Test Steps
1. Submit sitemap acquisition request
2. Monitor progress updates
3. Verify sequential processing (one at a time)
4. Check rate limiting enforcement
5. Wait for completion
6. Verify all pages processed

#### Expected Results
- Pages processed sequentially
- Rate limit of 10 pages/minute enforced
- Progress updates every page
- All pages from sitemap processed
- No resource exhaustion

#### Acceptance Criteria
- [ ] All pages processed
- [ ] Rate limiting working
- [ ] Memory usage stable
- [ ] No timeouts or errors

---

### TC-ACQ-022: Parallel Sitemap Processing

**Priority:** P0 - Critical  
**Type:** Integration Test  
**Feature:** Acquisition Workflow  

#### Description
Verify parallel sitemap processing achieves high throughput with memory-adaptive batching.

#### Preconditions
- Acquisition service running
- Large test sitemap (100+ URLs)
- Performance monitoring active

#### Test Data
```json
{
  "type": "sitemap",
  "url": "https://example.com/large-sitemap.xml",
  "collection_name": "parallel-test",
  "parallel": true,
  "batch_size": 20,
  "max_workers": 5
}
```

#### Test Steps
1. Submit parallel sitemap request
2. Monitor concurrent processing
3. Track memory usage
4. Verify batch adaptation
5. Measure throughput
6. Wait for completion

#### Expected Results
- Multiple pages processed concurrently
- Throughput > 100 pages/minute
- Memory-adaptive batching active
- Peak memory < 2GB
- All pages processed successfully

#### Acceptance Criteria
- [ ] Concurrent processing verified
- [ ] Throughput target met
- [ ] Memory usage controlled
- [ ] All pages acquired

#### Performance Metrics
- Target throughput: 100+ pages/minute
- Max memory: 2GB
- Success rate: >95%

---

### TC-ACQ-023: Recursive Site Crawling

**Priority:** P1 - High  
**Type:** Integration Test  
**Feature:** Acquisition Workflow  

#### Description
Verify recursive crawling discovers and processes linked pages up to configured depth.

#### Preconditions
- Acquisition service running
- Test website with known link structure
- Depth limit configured

#### Test Data
```json
{
  "type": "recursive",
  "url": "https://example.com/start",
  "collection_name": "recursive-test",
  "depth_limit": 3,
  "same_domain_only": true
}
```

#### Test Steps
1. Submit recursive acquisition request
2. Monitor link discovery
3. Track depth levels
4. Verify same-domain filtering
5. Check loop detection
6. Wait for completion

#### Expected Results
- Starting page processed (depth 0)
- Linked pages discovered and processed (depth 1-3)
- Pages at depth 4+ ignored
- External domains filtered out
- No infinite loops
- Duplicate URLs deduplicated

#### Acceptance Criteria
- [ ] Depth limit enforced
- [ ] Domain filtering working
- [ ] Loop detection active
- [ ] All valid pages processed

---

## Integration Tests - Progress Tracking

### TC-ACQ-030: Progress Event Emission

**Priority:** P0 - Critical  
**Type:** Integration Test  
**Feature:** Progress Tracking  

#### Description
Verify progress events are emitted at all stages of acquisition with accurate information.

#### Preconditions
- Event bus operational
- WebSocket connection established
- Acquisition job submitted

#### Test Data
```json
{
  "type": "sitemap",
  "url": "https://example.com/sitemap.xml",
  "collection_name": "progress-test"
}
```

#### Test Steps
1. Subscribe to progress events for job
2. Submit acquisition request
3. Capture all progress events
4. Verify event sequence and content

#### Expected Results
Events received in order:
1. `acquisition.started` - Job initiated
2. `acquisition.fetching` - Downloading pages
3. `acquisition.vectorizing` - Processing content
4. `acquisition.storing` - Storing in database
5. `acquisition.completed` - Job finished

Each event contains:
- Job ID
- Current stage
- Progress percentage
- Items processed
- ETA

#### Acceptance Criteria
- [ ] All expected events received
- [ ] Events in correct order
- [ ] Progress percentages accurate
- [ ] Event latency < 500ms

---

### TC-ACQ-031: Real-Time Progress Updates

**Priority:** P1 - High  
**Type:** Integration Test  
**Feature:** Progress Tracking  

#### Description
Verify real-time progress updates delivered to frontend with < 500ms latency.

#### Preconditions
- Frontend WebSocket connected
- Acquisition in progress
- Progress monitoring UI loaded

#### Test Steps
1. Start acquisition job
2. Monitor WebSocket messages
3. Measure event delivery latency
4. Verify UI updates in real-time
5. Check progress bar accuracy

#### Expected Results
- Progress events delivered via WebSocket
- Event latency < 500ms P95
- UI updates immediately
- Progress bar reflects actual progress
- ETA calculated and displayed

#### Acceptance Criteria
- [ ] Latency target met
- [ ] UI updates smoothly
- [ ] Progress accurate
- [ ] No event loss

#### Performance Metrics
- Event latency: < 500ms P95
- Update frequency: 1-5 seconds
- No missing events

---

## Integration Tests - Error Handling

### TC-ACQ-040: Network Timeout Handling

**Priority:** P1 - High  
**Type:** Integration Test  
**Feature:** Error Handling  

#### Description
Verify system gracefully handles network timeouts with retry logic.

#### Preconditions
- Acquisition service running
- Network simulation tool configured

#### Test Data
```json
{
  "type": "single_page",
  "url": "https://slow-server.example.com/page",
  "collection_name": "timeout-test",
  "timeout": 5
}
```

#### Test Steps
1. Configure simulated slow server (10s response)
2. Submit acquisition with 5s timeout
3. Verify timeout detected
4. Check retry mechanism triggered
5. Verify error handling

#### Expected Results
- Initial request times out after 5s
- Retry attempted (exponential backoff)
- After 3 retries, job marked as failed
- Error message logged
- User notified of failure

#### Acceptance Criteria
- [ ] Timeout detected correctly
- [ ] Retry logic executed
- [ ] Final failure handled gracefully
- [ ] Clear error message provided

---

### TC-ACQ-041: Invalid URL Handling

**Priority:** P1 - High  
**Type:** Integration Test  
**Feature:** Error Handling  

#### Description
Verify system rejects invalid URLs with appropriate error messages.

#### Test Data
```json
{
  "type": "single_page",
  "url": "not-a-valid-url",
  "collection_name": "invalid-test"
}
```

#### Test Steps
1. Submit request with invalid URL
2. Verify validation error returned
3. Check error message clarity

#### Expected Results
- Request rejected immediately
- HTTP 400 Bad Request returned
- Error message: "Invalid URL format"
- No job created
- No resources consumed

#### Acceptance Criteria
- [ ] Validation error returned
- [ ] Clear error message
- [ ] No job created
- [ ] Response time < 100ms

---

### TC-ACQ-042: Robots.txt Compliance

**Priority:** P1 - High  
**Type:** Integration Test  
**Feature:** Compliance  

#### Description
Verify system respects robots.txt disallow rules.

#### Preconditions
- Test server with robots.txt configured

#### Test Data
```
# robots.txt
User-agent: *
Disallow: /private/
Disallow: /admin/
```

#### Test Steps
1. Submit acquisition for disallowed URL
2. Verify robots.txt fetched and parsed
3. Check URL blocked
4. Verify error message

#### Expected Results
- robots.txt fetched before crawling
- Disallowed URLs skipped
- Error: "URL blocked by robots.txt"
- Compliance logged

#### Acceptance Criteria
- [ ] robots.txt respected
- [ ] Disallowed URLs blocked
- [ ] Compliance documented

---

## E2E Tests - Complete Workflows

### TC-ACQ-050: End-to-End Single Page Acquisition

**Priority:** P0 - Critical  
**Type:** E2E Test  
**Feature:** Complete Workflow  

#### Description
Complete user journey from login through acquisition to query validation.

#### Preconditions
- User account created
- System fully deployed
- Browser automation ready

#### Test Steps
1. **Login**: Navigate to /login, authenticate
2. **Navigate**: Go to /acquisition page
3. **Configure**: 
   - Select "Single Page" type
   - Enter URL: "https://example.com/doc"
   - Enter collection name: "E2E Test Collection"
   - Add description
4. **Submit**: Click "Start Acquisition"
5. **Monitor**: Watch real-time progress
6. **Verify**: Wait for completion summary
7. **Query**: Go to /query, search collection
8. **Validate**: Verify results from acquired content

#### Expected Results
- Login successful
- Acquisition form accessible
- Job submitted successfully
- Real-time progress visible
- Completion summary shows:
  - Pages processed: 1
  - Status: Completed
  - Time elapsed: < 30s
- Query returns relevant results
- Source attribution shows acquired page

#### Acceptance Criteria
- [ ] Complete workflow successful
- [ ] Progress updates received
- [ ] Content queryable
- [ ] End-to-end time < 2 minutes

---

### TC-ACQ-051: End-to-End Sitemap Acquisition

**Priority:** P0 - Critical  
**Type:** E2E Test  
**Feature:** Complete Workflow  

#### Description
Complete workflow for sitemap-based acquisition with progress monitoring.

#### Test Steps
1. Login to system
2. Navigate to /acquisition
3. Select "Sitemap" type
4. Enter sitemap URL
5. Configure:
   - Parallel processing: enabled
   - Batch size: 10
   - Collection name: "Sitemap E2E Test"
6. Submit acquisition
7. Monitor progress dashboard
8. View completion summary
9. Browse collection
10. Query acquired content

#### Expected Results
- Sitemap processed successfully
- All URLs from sitemap acquired
- Real-time progress shown
- Completion summary accurate
- Collection browsable
- Content searchable

#### Acceptance Criteria
- [ ] All pages acquired
- [ ] Progress accurate
- [ ] Summary complete
- [ ] Content queryable

---

### TC-ACQ-052: End-to-End Collaborative Monitoring

**Priority:** P1 - High  
**Type:** E2E Test  
**Feature:** Collaboration  

#### Description
Multiple users monitoring same acquisition with synchronized updates.

#### Preconditions
- Two user accounts created
- LiveKit collaboration enabled

#### Test Steps
1. User 1: Login and start acquisition
2. User 2: Login and navigate to same job
3. Both users monitor progress
4. Verify synchronized updates
5. User 1: Add annotation
6. User 2: Verify annotation visible
7. Both users view completion

#### Expected Results
- Both users see same progress
- Updates synchronized in real-time
- Annotations shared
- Collaboration seamless

#### Acceptance Criteria
- [ ] Progress synchronized
- [ ] Latency < 500ms
- [ ] Annotations shared
- [ ] No conflicts

---

## Performance Tests

### TC-ACQ-060: High-Volume Acquisition

**Priority:** P0 - Critical  
**Type:** Performance Test  
**Feature:** Scalability  

#### Description
Verify system handles 10 concurrent acquisitions without degradation.

#### Preconditions
- System fully scaled
- Performance monitoring active

#### Test Steps
1. Submit 10 acquisition jobs simultaneously
2. Monitor system resources
3. Track completion times
4. Measure throughput

#### Expected Results
- All 10 jobs complete successfully
- CPU usage < 80%
- Memory usage < 85%
- No timeouts or errors
- Average completion time acceptable

#### Acceptance Criteria
- [ ] All jobs successful
- [ ] Resource usage acceptable
- [ ] No performance degradation

#### Performance Metrics
- Concurrent jobs: 10
- Success rate: 100%
- CPU: < 80%
- Memory: < 85%

---

### TC-ACQ-061: Large Document Processing

**Priority:** P1 - High  
**Type:** Performance Test  
**Feature:** Scalability  

#### Description
Verify system handles very large documents (>10MB) without memory issues.

#### Test Data
- Large HTML document: 15MB
- Contains 50,000+ lines
- Multiple embedded images

#### Test Steps
1. Submit large document acquisition
2. Monitor memory usage
3. Track processing time
4. Verify chunking efficiency

#### Expected Results
- Document processed successfully
- Memory usage < 2GB
- Processing time < 5 minutes
- Chunks created efficiently
- No memory leaks

#### Acceptance Criteria
- [ ] Processing successful
- [ ] Memory controlled
- [ ] Time acceptable
- [ ] Efficient chunking

---

## Summary

**Total Test Cases in This Suite: 80**

### By Priority
- P0 Critical: 25 test cases
- P1 High: 40 test cases
- P2 Medium: 12 test cases
- P3 Low: 3 test cases

### By Type
- Unit Tests: 40 test cases
- Integration Tests: 25 test cases
- E2E Tests: 15 test cases

### Coverage
- Agent Selection: 100%
- Content Processing: 100%
- Acquisition Workflows: 100%
- Progress Tracking: 100%
- Error Handling: 100%
- Performance: Key scenarios covered

### Success Criteria
- ✅ All P0 tests must pass
- ✅ >95% P1 tests must pass
- ✅ Performance targets met
- ✅ No critical defects

---

**Document Control**
- **Version:** 7.1
- **Status:** Ready for Execution
- **Last Updated:** 2025-09-28
- **Related:** Test Plan v6.0, Specification 4.5

