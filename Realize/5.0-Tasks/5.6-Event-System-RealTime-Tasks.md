# Tasks: Event System & Real-Time Communication

**Input**: Specification 4.9-Citadel-Event-System.md, Technology Stack v3.2
**Prerequisites**: Kafka cluster deployed, LiveKit configured, WebSocket infrastructure ready

## Execution Flow (main)
```
1. Load event system specification
   → Extract: event types, streaming requirements, collaboration features
2. Load technology stack for dependencies
   → Apache Kafka 3.8.x, Socket.io 4.x, LiveKit, Redis Streams
3. Generate tasks by category:
   → Setup: Kafka cluster, event schemas, LiveKit
   → Tests: event tests, streaming tests, collaboration tests (TDD)
   → Core: event producers, event consumers, real-time updates
   → Integration: AG-UI event bus, provenance tracking, notifications
4. Apply task rules:
   → Different event types = mark [P] for parallel
   → Tests before implementation (TDD)
5. Number tasks sequentially (T449...)
6. Return: SUCCESS (event system and real-time communication ready)
```

## Format: `[ID] [P?] Description`
- **[P]**: Can run in parallel (different files, no dependencies)
- Include exact file paths in backend/src/services/events/ and backend/src/events/

## Phase 6.1: Setup & Infrastructure
- [ ] T449 Verify Kafka 3.8.x cluster deployment (3 brokers)
- [ ] T450 Create Kafka topics for AG-UI events
- [ ] T451 Configure Kafka partitioning strategy
- [ ] T452 Set up Schema Registry for event contracts
- [ ] T453 Install aiokafka 0.11.x (async Kafka client)
- [ ] T454 Install confluent-kafka-python 2.5.x
- [ ] T455 Install Socket.io 4.x server
- [ ] T456 Configure LiveKit server
- [ ] T457 Install LiveKit server SDK
- [ ] T458 Configure Redis Streams for lightweight messaging

## Phase 6.2: Event Schema Definition

### Core Event Schemas
- [ ] T459 [P] Define ProgressEvent schema in backend/src/events/schemas/progress_event.py
- [ ] T460 [P] Define ProvenanceEvent schema in backend/src/events/schemas/provenance_event.py
- [ ] T461 [P] Define CollaborationEvent schema in backend/src/events/schemas/collaboration_event.py
- [ ] T462 [P] Define SystemEvent schema in backend/src/events/schemas/system_event.py
- [ ] T463 [P] Define NotificationEvent schema in backend/src/events/schemas/notification_event.py
- [ ] T464 Create CloudEvents wrapper in backend/src/events/schemas/cloud_events.py
- [ ] T465 Register all schemas with Schema Registry

## Phase 6.3: Tests First (TDD) ⚠️ MUST COMPLETE BEFORE 6.4
**CRITICAL: These tests MUST be written and MUST FAIL before ANY implementation**

### Event Producer Tests
- [ ] T466 [P] Contract test EventProducer in backend/tests/contract/test_event_producer.py
- [ ] T467 [P] Contract test KafkaProducer in backend/tests/contract/test_kafka_producer.py
- [ ] T468 [P] Contract test WebSocketProducer in backend/tests/contract/test_websocket_producer.py
- [ ] T469 Integration test event publishing in backend/tests/integration/test_event_publishing.py

### Event Consumer Tests
- [ ] T470 [P] Contract test EventConsumer in backend/tests/contract/test_event_consumer.py
- [ ] T471 [P] Contract test KafkaConsumer in backend/tests/contract/test_kafka_consumer.py
- [ ] T472 [P] Contract test WebSocketConsumer in backend/tests/contract/test_websocket_consumer.py
- [ ] T473 Integration test event consumption in backend/tests/integration/test_event_consumption.py

### Real-Time Tests
- [ ] T474 [P] Contract test RealtimeNotifier in backend/tests/contract/test_realtime_notifier.py
- [ ] T475 [P] Contract test ProvenanceTracker in backend/tests/contract/test_event_provenance.py
- [ ] T476 Integration test end-to-end event flow in backend/tests/integration/test_e2e_events.py
- [ ] T477 Performance test: <500ms event latency

## Phase 6.4: Event Producer Implementation (ONLY after tests are failing)

### Kafka Producer
- [ ] T478 Implement KafkaProducer in backend/src/services/events/kafka_producer.py
- [ ] T479 Implement event serialization (JSON, Protobuf)
- [ ] T480 Implement partition key selection for ordering
- [ ] T481 Implement at-least-once delivery guarantee
- [ ] T482 Implement producer buffering and batching
- [ ] T483 Implement error handling and retry logic
- [ ] T484 Performance test: ≥1000 events/second

### WebSocket Producer
- [ ] T485 Implement WebSocketProducer in backend/src/services/events/websocket_producer.py
- [ ] T486 Implement Socket.io server integration
- [ ] T487 Implement room-based event broadcasting
- [ ] T488 Implement user-specific event targeting
- [ ] T489 Implement connection management
- [ ] T490 Implement reconnection handling

### Event Publishing Layer
- [ ] T491 Implement EventPublisher in backend/src/services/events/event_publisher.py
- [ ] T492 Implement multi-channel publishing (Kafka + WebSocket)
- [ ] T493 Implement event filtering and routing
- [ ] T494 Implement event priority handling
- [ ] T495 Implement event deduplication
- [ ] T496 Implement event rate limiting

## Phase 6.5: Event Consumer Implementation

### Kafka Consumer
- [ ] T497 Implement KafkaConsumer in backend/src/services/events/kafka_consumer.py
- [ ] T498 Implement consumer group management
- [ ] T499 Implement offset management and checkpointing
- [ ] T500 Implement message deserialization
- [ ] T501 Implement consumer rebalancing handling
- [ ] T502 Implement dead letter queue for failed events
- [ ] T503 Performance test: consume 1000+ events/second

### Event Handlers
- [ ] T504 [P] Implement ProgressEventHandler in backend/src/events/handlers/progress_handler.py
- [ ] T505 [P] Implement ProvenanceEventHandler in backend/src/events/handlers/provenance_handler.py
- [ ] T506 [P] Implement CollaborationEventHandler in backend/src/events/handlers/collaboration_handler.py
- [ ] T507 [P] Implement SystemEventHandler in backend/src/events/handlers/system_handler.py
- [ ] T508 [P] Implement NotificationEventHandler in backend/src/events/handlers/notification_handler.py

## Phase 6.6: AG-UI Event Bus Integration

### Event Bus Core
- [ ] T509 Implement EventBus in backend/src/services/events/event_bus.py
- [ ] T510 Implement event subscription management
- [ ] T511 Implement event filtering by type and metadata
- [ ] T512 Implement event persistence for replay
- [ ] T513 Implement event ordering guarantees
- [ ] T514 Implement event bus health monitoring

### Provenance Tracking
- [ ] T515 Implement ProvenanceTracker in backend/src/services/events/provenance_tracker.py
- [ ] T516 Track document source and origin metadata
- [ ] T517 Track processing steps and transformations
- [ ] T518 Track access and usage history
- [ ] T519 Generate provenance chains for audit
- [ ] T520 Implement provenance query interface

## Phase 6.7: Real-Time Progress Updates

### Progress Emitters
- [ ] T521 Integrate progress events in AcquisitionService
- [ ] T522 Integrate progress events in IndexingService
- [ ] T523 Integrate progress events in RetrievalService
- [ ] T524 Implement progress aggregation for multi-step operations
- [ ] T525 Implement progress percentage calculations
- [ ] T526 Implement ETA estimation for long-running jobs

### Status Updates
- [ ] T527 Implement StatusUpdateService in backend/src/services/events/status_updates.py
- [ ] T528 Emit status updates for job lifecycle (created, running, completed, failed)
- [ ] T529 Emit detailed stage updates (fetching, vectorizing, analyzing)
- [ ] T530 Emit error and warning events
- [ ] T531 Implement status summary generation

## Phase 6.8: LiveKit Collaboration Features

### LiveKit Integration
- [ ] T532 Implement LiveKitService in backend/src/services/collaboration/livekit_service.py
- [ ] T533 Implement room creation for acquisition monitoring
- [ ] T534 Implement participant management
- [ ] T535 Implement access token generation
- [ ] T536 Implement data channel for custom events
- [ ] T537 Implement recording capabilities

### Collaboration Features
- [ ] T538 Implement co-monitoring for acquisition runs
- [ ] T539 Implement shared cursor positions
- [ ] T540 Implement collaborative annotations
- [ ] T541 Implement real-time chat
- [ ] T542 Implement voice communication for troubleshooting
- [ ] T543 Implement screen sharing capabilities

### Voice Integration
- [ ] T544 Implement voice-to-text transcription service
- [ ] T545 Implement voice query processing
- [ ] T546 Implement voice response playback
- [ ] T547 Implement multi-language voice support
- [ ] T548 Integrate voice commands for UI control

## Phase 6.9: Notification System

### Notification Manager
- [ ] T549 Implement NotificationManager in backend/src/services/notifications/notification_manager.py
- [ ] T550 Implement notification preferences per user
- [ ] T551 Implement notification channels (email, SMS, push, in-app)
- [ ] T552 Implement notification templates
- [ ] T553 Implement notification batching and digest
- [ ] T554 Implement notification history and tracking

### Notification Types
- [ ] T555 [P] Implement acquisition completion notifications
- [ ] T556 [P] Implement query result notifications
- [ ] T557 [P] Implement system alert notifications
- [ ] T558 [P] Implement collaboration invitation notifications
- [ ] T559 [P] Implement security event notifications
- [ ] T560 Implement custom user-defined alerts

## Phase 6.10: Event Analytics

### Event Tracking
- [ ] T561 Implement EventAnalytics in backend/src/services/analytics/event_analytics.py
- [ ] T562 Track event volumes and rates
- [ ] T563 Track event latency and delivery times
- [ ] T564 Track consumer lag and backlog
- [ ] T565 Generate event system health reports
- [ ] T566 Implement event replay for debugging

## Phase 6.11: API Endpoints

### Event API
- [ ] T567 GET /api/v1/events/stream endpoint (WebSocket) in backend/src/api/v1/events.py
- [ ] T568 POST /api/v1/events/subscribe endpoint
- [ ] T569 DELETE /api/v1/events/subscribe/{subscription_id} endpoint
- [ ] T570 GET /api/v1/events/history endpoint (with filtering)
- [ ] T571 GET /api/v1/events/{event_id} endpoint

### Collaboration API
- [ ] T572 POST /api/v1/collaboration/rooms endpoint
- [ ] T573 GET /api/v1/collaboration/rooms/{room_id}/token endpoint
- [ ] T574 POST /api/v1/collaboration/rooms/{room_id}/invite endpoint
- [ ] T575 DELETE /api/v1/collaboration/rooms/{room_id} endpoint

### Notification API
- [ ] T576 GET /api/v1/notifications endpoint
- [ ] T577 PUT /api/v1/notifications/{notification_id}/read endpoint
- [ ] T578 GET /api/v1/notifications/preferences endpoint
- [ ] T579 PUT /api/v1/notifications/preferences endpoint

## Phase 6.12: Performance Optimization
- [ ] T580 Implement event compression for bandwidth optimization
- [ ] T581 Implement WebSocket connection pooling
- [ ] T582 Implement event batching for efficiency
- [ ] T583 Implement event caching for replay
- [ ] T584 Performance test: ≤500ms end-to-end event latency
- [ ] T585 Load test: support 1000+ concurrent WebSocket connections

## Phase 6.13: Documentation & Testing
- [ ] T586 [P] Document event schemas in backend/docs/events/schemas.md
- [ ] T587 [P] Document event flows in backend/docs/events/flows.md
- [ ] T588 [P] Document LiveKit integration in backend/docs/collaboration/livekit.md
- [ ] T589 [P] Create event examples in backend/examples/events/
- [ ] T590 [P] Update API documentation with WebSocket specs
- [ ] T591 Run manual testing scenarios from specification
- [ ] T592 Code review focusing on event reliability

## Dependencies
```
Setup (T449-T458) → Event Schemas (T459-T465)
Event Schemas → Tests (T466-T477)
Tests → Kafka Producer (T478-T484)
Tests → WebSocket Producer (T485-T490)
Producers → Event Publishing (T491-T496)
Publishing → Kafka Consumer (T497-T503)
Consumer → Event Handlers (T504-T508)
Handlers → Event Bus (T509-T514)
Event Bus → Provenance (T515-T520)
Event Bus → Progress Updates (T521-T531)
All Core → LiveKit (T532-T548)
LiveKit → Notifications (T549-T560)
Notifications → Analytics (T561-T566)
All Core → API Endpoints (T567-T579)
API → Performance Optimization (T580-T585)
All Implementation → Documentation (T586-T592)
```

## Parallel Execution Examples
```
# Event Schema Definition (T459-T463):
Task T459: Define ProgressEvent schema
Task T460: Define ProvenanceEvent schema
Task T461: Define CollaborationEvent schema
Task T462: Define SystemEvent schema
Task T463: Define NotificationEvent schema

# Event Producer Tests (T466-T468):
Task T466: Contract test EventProducer
Task T467: Contract test KafkaProducer
Task T468: Contract test WebSocketProducer

# Event Handlers (T504-T508):
Task T504: Implement ProgressEventHandler
Task T505: Implement ProvenanceEventHandler
Task T506: Implement CollaborationEventHandler
Task T507: Implement SystemEventHandler
Task T508: Implement NotificationEventHandler
```

## Event System Performance Targets

### Latency Requirements
- **Event Publishing:** <50ms P95
- **Kafka Delivery:** <200ms P95
- **WebSocket Delivery:** <100ms P95
- **End-to-End:** ≤500ms P95

### Throughput Requirements
- **Event Production:** ≥1000 events/second
- **Event Consumption:** ≥1000 events/second
- **Concurrent WebSockets:** ≥1000 connections
- **Room Participants:** ≥50 per room

## Event Types & Schemas

### ProgressEvent
```json
{
  "eventType": "acquisition.progress",
  "jobId": "uuid",
  "stage": "vectorizing",
  "progress": 45.5,
  "itemsProcessed": 455,
  "totalItems": 1000,
  "eta": "2025-09-28T15:30:00Z",
  "timestamp": "2025-09-28T15:25:00Z"
}
```

### ProvenanceEvent
```json
{
  "eventType": "document.provenance",
  "documentId": "uuid",
  "sourceUrl": "https://example.com/doc",
  "acquisitionJobId": "uuid",
  "processingSteps": [],
  "metadata": {},
  "timestamp": "2025-09-28T15:25:00Z"
}
```

## Validation Checklist
- [x] All event types have schema definitions
- [x] Event producers and consumers tested
- [x] End-to-end event flow tested
- [x] Performance targets defined (≤500ms)
- [x] LiveKit collaboration features implemented
- [x] Notification system comprehensive
- [x] Event persistence for replay
- [x] API endpoints properly defined

---

**Status:** Event System & Real-Time Communication - Ready for Implementation  
**Next Phase:** Frontend UI Development (Phase 7)

