# Tasks: Retrieval & Query Processing

**Input**: Specifications 4.2-Citadel-Query-Interface.md, 4.7-Citadel-Semantic-Search.md, Technology Stack v3.2
**Prerequisites**: Vector processing complete, LiteLLM configured, Qdrant operational

## Execution Flow (main)
```
1. Load query and search specifications
   → Extract: query processing, search capabilities, response generation
2. Load technology stack for dependencies
   → LiteLLM 1.51.x, Qdrant client, OpenAI/Anthropic/Cohere SDKs
3. Generate tasks by category:
   → Setup: LLM router, query infrastructure
   → Tests: query tests, search tests, response tests (TDD)
   → Core: query processing, semantic search, response generation
   → Integration: retrieval service, context assembly, provenance
4. Apply task rules:
   → Different query agents = mark [P] for parallel
   → Tests before implementation (TDD)
5. Number tasks sequentially (T198...)
6. Return: SUCCESS (retrieval and query system ready)
```

## Format: `[ID] [P?] Description`
- **[P]**: Can run in parallel (different files, no dependencies)
- Include exact file paths in backend/src/agents/retrieval/ and backend/src/services/

## Phase 4.1: Setup & LLM Configuration
- [ ] T198 Install LiteLLM 1.51.x and provider SDKs
- [ ] T199 Configure OpenAI API integration
- [ ] T200 Configure Anthropic API integration
- [ ] T201 Configure Cohere API integration
- [ ] T202 Configure Groq API integration
- [ ] T203 Configure Mistral API integration
- [ ] T204 Set up local LLM connections (hx-llm01, hx-llm02)
- [ ] T205 Configure LiteLLM router with fallback logic
- [ ] T206 Create LLM model selection strategy

## Phase 4.2: Tests First (TDD) ⚠️ MUST COMPLETE BEFORE 4.3
**CRITICAL: These tests MUST be written and MUST FAIL before ANY implementation**

### Query Processing Tests
- [ ] T207 [P] Contract test QueryProcessor in backend/tests/contract/test_query_processor.py
- [ ] T208 [P] Contract test QueryParser in backend/tests/contract/test_query_parser.py
- [ ] T209 [P] Contract test IntentExtractor in backend/tests/contract/test_intent_extractor.py
- [ ] T210 Integration test query pipeline in backend/tests/integration/test_query_pipeline.py

### Search Engine Tests
- [ ] T211 [P] Contract test VectorSearch in backend/tests/contract/test_vector_search.py
- [ ] T212 [P] Contract test HybridSearch in backend/tests/contract/test_hybrid_search.py
- [ ] T213 [P] Contract test MetadataFilter in backend/tests/contract/test_metadata_filter.py
- [ ] T214 Integration test search operations in backend/tests/integration/test_search_operations.py

### Response Generation Tests
- [ ] T215 [P] Contract test ContextBuilder in backend/tests/contract/test_context_builder.py
- [ ] T216 [P] Contract test ResponseGenerator in backend/tests/contract/test_response_generator.py
- [ ] T217 [P] Contract test ProvenanceTracker in backend/tests/contract/test_provenance_tracker.py
- [ ] T218 Integration test complete retrieval flow in backend/tests/integration/test_retrieval_flow.py

## Phase 4.3: Query Processing Implementation (ONLY after tests are failing)

### Query Agents
- [ ] T219 [P] Implement QueryProcessor in backend/src/agents/retrieval/query_processor.py
- [ ] T220 [P] Implement QueryParser in backend/src/agents/retrieval/query_parser.py
- [ ] T221 [P] Implement IntentExtractor in backend/src/agents/retrieval/intent_extractor.py
- [ ] T222 Implement QueryOptimizer in backend/src/agents/retrieval/query_optimizer.py

### Query Understanding
- [ ] T223 [P] Implement query embedding generation
- [ ] T224 [P] Implement query expansion logic
- [ ] T225 [P] Implement query suggestion generation
- [ ] T226 Implement multi-turn conversation context tracking
- [ ] T227 Implement query history management

## Phase 4.4: Search Engine Implementation

### Vector Search
- [ ] T228 Implement VectorSearch in backend/src/services/vector_search.py
- [ ] T229 Implement similarity scoring algorithms
- [ ] T230 Implement result ranking based on relevance
- [ ] T231 Implement cross-collection search
- [ ] T232 Performance test: <100ms P95 for vector search

### Hybrid Search
- [ ] T233 Implement HybridSearch combining vector + keyword
- [ ] T234 Implement keyword search using PostgreSQL full-text
- [ ] T235 Implement result fusion and re-ranking
- [ ] T236 Implement search result diversification
- [ ] T237 Performance test: sub-second hybrid search

### Metadata Filtering
- [ ] T238 Implement MetadataFilter in backend/src/services/metadata_filter.py
- [ ] T239 Implement collection-based filtering
- [ ] T240 Implement date range filtering
- [ ] T241 Implement document type filtering
- [ ] T242 Implement custom field filtering

## Phase 4.5: Context Assembly

### Context Builder
- [ ] T243 Implement ContextBuilder in backend/src/agents/retrieval/context_builder.py
- [ ] T244 Implement relevant chunk retrieval
- [ ] T245 Implement chunk ordering and ranking
- [ ] T246 Implement context window optimization
- [ ] T247 Implement multi-source context assembly
- [ ] T248 Performance test: <500ms context assembly

### Relevance Scoring
- [ ] T249 Implement RelevanceScorer in backend/src/agents/retrieval/relevance_scorer.py
- [ ] T250 Implement semantic similarity scoring
- [ ] T251 Implement recency scoring
- [ ] T252 Implement authority scoring
- [ ] T253 Implement composite scoring algorithm

## Phase 4.6: Response Generation

### LLM Integration
- [ ] T254 Implement ResponseGenerator in backend/src/agents/retrieval/response_generator.py
- [ ] T255 Implement LLM request formatting
- [ ] T256 Implement streaming response handling
- [ ] T257 Implement response validation
- [ ] T258 Implement fallback LLM logic
- [ ] T259 Performance test: P95 ≤2.0s end-to-end

### Source Attribution
- [ ] T260 Implement ProvenanceTracker in backend/src/agents/retrieval/provenance_tracker.py
- [ ] T261 Implement source reference extraction
- [ ] T262 Implement citation formatting
- [ ] T263 Implement confidence scoring
- [ ] T264 Implement source link generation

## Phase 4.7: Retrieval Service Integration
- [ ] T265 Create RetrievalService in backend/src/services/retrieval_service.py
- [ ] T266 Implement query orchestration workflow
- [ ] T267 Implement search orchestration
- [ ] T268 Implement context assembly orchestration
- [ ] T269 Implement response generation orchestration
- [ ] T270 Implement error handling and graceful degradation
- [ ] T271 Implement caching for frequent queries

## Phase 4.8: Conversation Management
- [ ] T272 Implement ConversationManager in backend/src/services/conversation_manager.py
- [ ] T273 Implement conversation state tracking
- [ ] T274 Implement context memory across turns
- [ ] T275 Implement conversation history storage
- [ ] T276 Implement conversation export
- [ ] T277 Implement conversation search

## Phase 4.9: Query Analytics
- [ ] T278 Implement QueryAnalytics in backend/src/services/query_analytics.py
- [ ] T279 Track query patterns and trends
- [ ] T280 Track result click-through rates
- [ ] T281 Track user satisfaction metrics
- [ ] T282 Generate query insights reports
- [ ] T283 Implement A/B testing framework for search

## Phase 4.10: Performance Optimization
- [ ] T284 Implement query result caching with Redis
- [ ] T285 Implement search result pagination
- [ ] T286 Implement lazy loading for large result sets
- [ ] T287 Implement connection pooling for LLM APIs
- [ ] T288 Implement request batching for efficiency
- [ ] T289 Performance test: ≥200 RPS throughput

## Phase 4.11: API Endpoints
- [ ] T290 POST /api/v1/queries endpoint in backend/src/api/v1/queries.py
- [ ] T291 GET /api/v1/queries/{query_id}/results endpoint
- [ ] T292 GET /api/v1/queries/{query_id}/sources endpoint
- [ ] T293 POST /api/v1/conversations endpoint
- [ ] T294 GET /api/v1/conversations/{conversation_id} endpoint
- [ ] T295 GET /api/v1/conversations endpoint (list with filters)
- [ ] T296 GET /api/v1/suggestions endpoint (query suggestions)

## Phase 4.12: Advanced Features
- [ ] T297 Implement complex query support (comparisons, analysis)
- [ ] T298 Implement multi-collection aggregation
- [ ] T299 Implement query result export (JSON, CSV, PDF)
- [ ] T300 Implement saved searches functionality
- [ ] T301 Implement search alerts and notifications
- [ ] T302 Implement voice query processing

## Phase 4.13: Documentation & Polish
- [ ] T303 [P] Document query interface in backend/docs/retrieval/queries.md
- [ ] T304 [P] Document search algorithms in backend/docs/retrieval/search.md
- [ ] T305 [P] Create retrieval examples in backend/examples/retrieval/
- [ ] T306 [P] Update API documentation with OpenAPI specs
- [ ] T307 Run manual testing scenarios from specification
- [ ] T308 Code review and refactoring for performance

## Dependencies
```
Setup (T198-T206) → Tests (T207-T218)
Tests (T207-T218) → Query Processing (T219-T227)
Query Processing → Search Engine (T228-T242)
Search Engine → Context Assembly (T243-T253)
Context Assembly → Response Generation (T254-T264)
Response Generation → Retrieval Service (T265-T271)
Retrieval Service → Conversation Management (T272-T277)
All Core → Query Analytics (T278-T283)
Analytics → Performance Optimization (T284-T289)
Retrieval Service → API Endpoints (T290-T296)
API Endpoints → Advanced Features (T297-T302)
All Implementation → Documentation (T303-T308)
```

## Parallel Execution Examples
```
# Query Processing Tests (T207-T209):
Task T207: Contract test QueryProcessor
Task T208: Contract test QueryParser
Task T209: Contract test IntentExtractor

# Search Engine Tests (T211-T213):
Task T211: Contract test VectorSearch
Task T212: Contract test HybridSearch
Task T213: Contract test MetadataFilter

# Query Processing Implementation (T219-T221):
Task T219: Implement QueryProcessor
Task T220: Implement QueryParser
Task T221: Implement IntentExtractor

# Query Understanding (T223-T225):
Task T223: Implement query embedding
Task T224: Implement query expansion
Task T225: Implement query suggestions
```

## Performance Targets

### Latency Requirements
- **Query Processing:** <50ms
- **Vector Search:** <100ms P95
- **Context Assembly:** <500ms
- **Response Generation:** <1500ms (excluding streaming)
- **End-to-End:** ≤2.0s P95

### Throughput Requirements
- **Concurrent Queries:** ≥200 RPS
- **Conversation Sessions:** ≥1000 active sessions
- **Cache Hit Rate:** ≥60%

## Query Processing Notes

### Natural Language Understanding
- Intent extraction using NLP
- Entity recognition for filters
- Query expansion using synonyms
- Multi-language support

### Search Strategies

**Vector Search:**
- Semantic similarity using embeddings
- Cosine distance metric
- Top-k retrieval (k=10-50)
- Metadata filtering support

**Hybrid Search:**
- 70% vector similarity weight
- 30% keyword match weight
- BM25 for keyword scoring
- Result fusion and re-ranking

**Metadata Filtering:**
- Collection-based filtering
- Date range filtering (created, updated)
- Document type filtering
- Custom field filtering

### Response Generation

**Context Window Management:**
- Maximum context: 8000 tokens
- Chunk selection strategy
- Source diversity balancing
- Relevance-based ordering

**LLM Configuration:**
- Primary: GPT-4 (high quality)
- Fallback: Claude 3.5 Sonnet
- Secondary: gpt-oss:20b (local)
- Temperature: 0.3 (factual responses)

**Source Attribution:**
- Inline citations [1], [2]
- Source list with URLs
- Excerpt highlighting
- Confidence scores

## Validation Checklist
- [x] All query components have tests
- [x] All search operations have tests
- [x] Tests before implementation (TDD)
- [x] Parallel tasks truly independent
- [x] Performance targets defined and testable
- [x] LLM fallback logic implemented
- [x] Provenance tracking comprehensive
- [x] API endpoints properly defined

---

**Status:** Retrieval & Query Processing - Ready for Implementation  
**Next Phase:** Authentication & Authorization (Phase 5)

