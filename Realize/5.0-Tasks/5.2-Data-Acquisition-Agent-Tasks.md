# Tasks: Data Acquisition Agents

**Input**: Specification 4.5-Citadel-Data-Acquisition.md, Technology Stack v3.2
**Prerequisites**: Infrastructure setup complete, Pydantic-AI framework configured

## Execution Flow (main)
```
1. Load data acquisition specification
   → Extract: agent types, capabilities, parameters, validation requirements
2. Load technology stack for dependencies
   → Pydantic-AI 0.0.14, Crawl4AI 0.4.x, Playwright 1.48.x
3. Generate tasks by category:
   → Setup: project structure, dependencies, base agent framework
   → Tests: agent contract tests, integration tests (TDD)
   → Agents: specialized agent implementations
   → Integration: service layer, job scheduling, progress tracking
4. Apply task rules:
   → Different agents = mark [P] for parallel
   → Tests before implementation (TDD)
   → Base agent before specialized agents
5. Number tasks sequentially (T059...)
6. Return: SUCCESS (data acquisition agents ready)
```

## Format: `[ID] [P?] Description`
- **[P]**: Can run in parallel (different files, no dependencies)
- Include exact file paths in backend/src/agents/acquisition/

## Phase 2.1: Setup & Foundation
- [ ] T059 Create backend/src/agents/ directory structure
- [ ] T060 Create backend/src/agents/acquisition/ directory
- [ ] T061 Install Pydantic-AI 0.0.14 and dependencies
- [ ] T062 Install Crawl4AI 0.4.x with Playwright 1.48.x
- [ ] T063 Configure Playwright browser automation
- [ ] T064 Create base agent framework in backend/src/agents/base_agent.py

## Phase 2.2: Tests First (TDD) ⚠️ MUST COMPLETE BEFORE 2.3
**CRITICAL: These tests MUST be written and MUST FAIL before ANY implementation**

### Agent Contract Tests
- [ ] T065 [P] Contract test SinglePageAgent in backend/tests/contract/test_single_page_agent.py
- [ ] T066 [P] Contract test SequentialSitemapAgent in backend/tests/contract/test_sequential_sitemap_agent.py
- [ ] T067 [P] Contract test ParallelSitemapAgent in backend/tests/contract/test_parallel_sitemap_agent.py
- [ ] T068 [P] Contract test FileProcessingAgent in backend/tests/contract/test_file_processing_agent.py
- [ ] T069 [P] Contract test RecursiveExplorationAgent in backend/tests/contract/test_recursive_exploration_agent.py

### Integration Tests
- [ ] T070 [P] Integration test single page acquisition in backend/tests/integration/test_single_page_acquisition.py
- [ ] T071 [P] Integration test sitemap processing in backend/tests/integration/test_sitemap_processing.py
- [ ] T072 [P] Integration test recursive crawling in backend/tests/integration/test_recursive_crawling.py
- [ ] T073 [P] Integration test file upload processing in backend/tests/integration/test_file_processing.py
- [ ] T074 Integration test agent selection logic in backend/tests/integration/test_agent_selection.py

## Phase 2.3: Agent Implementation (ONLY after tests are failing)

### Base Agent Components
- [ ] T075 Implement BaseAgent with Pydantic-AI in backend/src/agents/base_agent.py
- [ ] T076 Implement AgentConfig model in backend/src/agents/models/agent_config.py
- [ ] T077 Implement AgentResult model in backend/src/agents/models/agent_result.py
- [ ] T078 Implement progress tracking utilities in backend/src/agents/utils/progress.py

### Specialized Agents
- [ ] T079 [P] Implement SinglePageAgent in backend/src/agents/acquisition/single_page_agent.py
- [ ] T080 [P] Implement SequentialSitemapAgent in backend/src/agents/acquisition/sequential_sitemap_agent.py
- [ ] T081 [P] Implement ParallelSitemapAgent in backend/src/agents/acquisition/parallel_sitemap_agent.py
- [ ] T082 [P] Implement FileProcessingAgent in backend/src/agents/acquisition/file_processing_agent.py
- [ ] T083 [P] Implement RecursiveExplorationAgent in backend/src/agents/acquisition/recursive_exploration_agent.py

### Agent Tools & Utilities
- [ ] T084 [P] Implement HTML extraction tool in backend/src/agents/tools/html_extractor.py
- [ ] T085 [P] Implement Markdown conversion tool in backend/src/agents/tools/markdown_converter.py
- [ ] T086 [P] Implement sitemap parser tool in backend/src/agents/tools/sitemap_parser.py
- [ ] T087 [P] Implement link discovery tool in backend/src/agents/tools/link_discovery.py
- [ ] T088 Implement rate limiting tool in backend/src/agents/tools/rate_limiter.py

## Phase 2.4: Agent Management Layer
- [ ] T089 Implement AgentManager in backend/src/services/agent_manager.py
- [ ] T090 Implement agent selection logic based on source type
- [ ] T091 Implement agent lifecycle management (start, stop, monitor)
- [ ] T092 Implement agent resource allocation and limits
- [ ] T093 Implement agent health monitoring and recovery

## Phase 2.5: Acquisition Service Integration
- [ ] T094 Create AcquisitionService in backend/src/services/acquisition_service.py
- [ ] T095 Implement job queue with prioritization
- [ ] T096 Implement job scheduling and execution
- [ ] T097 Implement progress tracking with AG-UI event emission
- [ ] T098 Implement failure handling with retry logic
- [ ] T099 Implement job history and analytics

## Phase 2.6: Configuration & Parameters
- [ ] T100 [P] Implement chunk size configuration in backend/src/config/chunking.py
- [ ] T101 [P] Implement batch size configuration in backend/src/config/batching.py
- [ ] T102 [P] Implement depth limit configuration in backend/src/config/crawling.py
- [ ] T103 [P] Implement robots.txt compliance in backend/src/config/compliance.py
- [ ] T104 Create default configuration templates in backend/configs/acquisition/

## Phase 2.7: Validation & Quality Assurance
- [ ] T105 Implement content validation agent in backend/src/agents/processing/validation_agent.py
- [ ] T106 Implement quality scoring in backend/src/agents/processing/quality_scorer.py
- [ ] T107 Implement duplicate detection in backend/src/agents/processing/duplicate_detector.py
- [ ] T108 Integration test complete acquisition pipeline with validation

## Phase 2.8: Error Handling & Resilience
- [ ] T109 Implement graceful failure handling for network errors
- [ ] T110 Implement retry mechanism with exponential backoff
- [ ] T111 Implement circuit breaker for external services
- [ ] T112 Implement dead letter queue for failed jobs
- [ ] T113 Integration test failure recovery scenarios

## Phase 2.9: Performance Optimization
- [ ] T114 Implement connection pooling for HTTP requests
- [ ] T115 Implement memory-adaptive batching for large acquisitions
- [ ] T116 Implement parallel processing optimization
- [ ] T117 Implement caching for repeated URLs
- [ ] T118 Performance test: acquire 1000 pages in <5 minutes

## Phase 2.10: API Endpoints
- [ ] T119 POST /api/v1/acquisitions endpoint in backend/src/api/v1/acquisitions.py
- [ ] T120 GET /api/v1/acquisitions/{job_id} endpoint
- [ ] T121 GET /api/v1/acquisitions/{job_id}/progress endpoint
- [ ] T122 DELETE /api/v1/acquisitions/{job_id} endpoint (cancel job)
- [ ] T123 GET /api/v1/acquisitions endpoint (list jobs with filters)

## Phase 2.11: Documentation & Polish
- [ ] T124 [P] Document agent interfaces and tools in backend/docs/agents/acquisition.md
- [ ] T125 [P] Create acquisition examples in backend/examples/acquisition/
- [ ] T126 [P] Update API documentation with OpenAPI specs
- [ ] T127 Run manual testing scenarios from specification
- [ ] T128 Code review and refactoring for code quality

## Dependencies
```
Setup (T059-T064) → Tests (T065-T074)
Tests (T065-T074) → Base Agent (T075-T078)
Base Agent (T075-T078) → Specialized Agents (T079-T083)
Base Agent → Agent Tools (T084-T088)
Specialized Agents → Agent Management (T089-T093)
Agent Management → Acquisition Service (T094-T099)
Acquisition Service → Configuration (T100-T104)
All Agents → Validation (T105-T108)
Validation → Error Handling (T109-T113)
Error Handling → Performance Optimization (T114-T118)
Acquisition Service → API Endpoints (T119-T123)
All Implementation → Documentation (T124-T128)
```

## Parallel Execution Examples
```
# Contract Tests Phase (T065-T069):
Task T065: Contract test SinglePageAgent
Task T066: Contract test SequentialSitemapAgent
Task T067: Contract test ParallelSitemapAgent
Task T068: Contract test FileProcessingAgent
Task T069: Contract test RecursiveExplorationAgent

# Agent Implementation Phase (T079-T083):
Task T079: Implement SinglePageAgent
Task T080: Implement SequentialSitemapAgent
Task T081: Implement ParallelSitemapAgent
Task T082: Implement FileProcessingAgent
Task T083: Implement RecursiveExplorationAgent

# Agent Tools Phase (T084-T087):
Task T084: Implement HTML extraction tool
Task T085: Implement Markdown conversion tool
Task T086: Implement sitemap parser tool
Task T087: Implement link discovery tool
```

## Agent-Specific Notes

### SinglePageAgent
- Focus: Basic webpage crawling with markdown conversion
- Tools: HTML extractor, Markdown converter
- Performance: <2 seconds per page

### SequentialSitemapAgent
- Focus: Resource-efficient sequential processing
- Tools: Sitemap parser, HTML extractor
- Performance: 100 pages per minute with rate limiting

### ParallelSitemapAgent
- Focus: High-throughput parallel processing
- Tools: Sitemap parser, memory-adaptive dispatcher
- Performance: 1000+ pages per minute with resource management

### FileProcessingAgent
- Focus: Local file and upload handling
- Tools: File readers (PDF, DOCX, TXT, MD)
- Performance: Process 100MB files in <10 seconds

### RecursiveExplorationAgent
- Focus: Autonomous site discovery with depth limits
- Tools: Link discovery, duplicate detection
- Performance: Configurable depth (1-6 layers), respectful crawling

## Validation Checklist
- [x] All agents have contract tests
- [x] All agents have integration tests
- [x] Tests before implementation (TDD)
- [x] Parallel tasks truly independent
- [x] Agent tools modular and reusable
- [x] Error handling comprehensive
- [x] Performance targets defined
- [x] API endpoints properly defined

---

**Status:** Data Acquisition Agents - Ready for Implementation  
**Next Phase:** Vector Processing & Embedding Agents (Phase 3)
